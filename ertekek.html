import React, { useState, useCallback, useRef } from 'react';
import { DragDropContext, Droppable, Draggable } from 'react-beautiful-dnd';

// Sample values data
const VALUES = [
  { id: 'Acceptance', label: 'Acceptance', description: 'to be accepted as I am' },
  // ... add remaining values
];

function StepSelector({ values, selected, toggleSelect, onNext }) {
  return (
    <div className="p-4">
      <h2 className="text-xl font-semibold mb-4">Select 10–15 Values</h2>
      <div className="grid grid-cols-3 gap-3">
        {values.map((v) => (
          <button
            key={v.id}
            onClick={() => toggleSelect(v.id)}
            className={`p-3 border rounded-lg text-left ${
              selected.includes(v.id) ? 'bg-blue-100 border-blue-400' : 'bg-white'
            }`}
          >
            <div className="font-bold uppercase">{v.label}</div>
            <div className="text-sm text-gray-600">{v.description}</div>
          </button>
        ))}
      </div>
      <button
        onClick={onNext}
        disabled={selected.length < 10 || selected.length > 15}
        className="mt-4 px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50"
      >Next</button>
    </div>
  );
}

function StepPool({ items, onComplete }) {
  const [top5, setTop5] = useState([]);
  const [next5, setNext5] = useState([]);

  const onDragEnd = useCallback(({ source, destination }) => {
    if (!destination) return;
    const srcList = source.droppableId === 'pool' ? items : source.droppableId === 'top5' ? top5 : next5;
    const dstList = destination.droppableId === 'top5' ? top5 : destination.droppableId === 'next5' ? next5 : items;
    if (dstList.length >= 5) return alert('Max 5 items');

    const [moved] = srcList.splice(source.index, 1);
    dstList.splice(destination.index, 0, moved);
    setTop5([...top5]);
    setNext5([...next5]);
    if (top5.length === 5 && next5.length === 5) onComplete([...top5, ...next5]);
  }, [items, top5, next5, onComplete]);

  return (
    <DragDropContext onDragEnd={onDragEnd}>
      <div className="p-4 space-y-6">
        <h2 className="text-xl font-semibold">Sort Into Top 1–5 and Top 6–10</h2>
        <Droppable droppableId="pool" direction="horizontal">
          {(provided) => (
            <div ref={provided.innerRef} {...provided.droppableProps} className="flex space-x-2">
              {items.map((id, idx) => (
                <Draggable key={id} draggableId={id} index={idx}>
                  {(p) => <div ref={p.innerRef} {...p.draggableProps} {...p.dragHandleProps} className="p-2 bg-gray-100 rounded">{id}</div>}
                </Draggable>
              ))}
              {provided.placeholder}
            </div>
          )}
        </Droppable>
        <div className="flex space-x-4">
          <Droppable droppableId="top5">
            {(prov) => (
              <div ref={prov.innerRef} {...prov.droppableProps} className="w-1/2 min-h-[100px] p-4 border rounded">
                <h3 className="font-semibold">TOP 1–5</h3>
                {top5.map((id, i) => (
                  <Draggable key={id} draggableId={id} index={i}>
                    {(p) => <div ref={p.innerRef} {...p.draggableProps} {...p.dragHandleProps} className="p-2 bg-blue-50 rounded">{id}</div>}
                  </Draggable>
                ))}
                {prov.placeholder}
              </div>
            )}
          </Droppable>
          <Droppable droppableId="next5">
            {(prov) => (
              <div ref={prov.innerRef} {...prov.droppableProps} className="w-1/2 min-h-[100px] p-4 border rounded">
                <h3 className="font-semibold">TOP 6–10</h3>
                {next5.map((id, i) => (
                  <Draggable key={id} draggableId={id} index={i}>
                    {(p) => <div ref={p.innerRef} {...p.draggableProps} {...p.dragHandleProps} className="p-2 bg-blue-50 rounded">{id}</div>}
                  </Draggable>
                ))}
                {prov.placeholder}
              </div>
            )}
          </Droppable>
        </div>
      </div>
    </DragDropContext>
  );
}

function StepRank({ top5, onFinalize }) {
  const [order, setOrder] = useState(Array(5).fill(null));

  const onDragEnd = useCallback(({ source, destination }) => {
    if (!destination) return;
    const newOrder = [...order];
    newOrder[destination.index] = source.draggableId;
    setOrder(newOrder);
    if (newOrder.every((v) => v)) onFinalize(newOrder);
  }, [order, onFinalize]);

  return (
    <DragDropContext onDragEnd={onDragEnd}>
      <div className="p-4 space-y-4">
        <h2 className="text-xl font-semibold">Rank Your Top 5</h2>
        <div className="grid grid-cols-5 gap-2">
          {order.map((val, idx) => (
            <Droppable key={idx} droppableId={`slot-${idx}`}>
              {(prov) => (
                <div ref={prov.innerRef} {...prov.droppableProps} className="h-20 p-2 border rounded text-center">
                  {val || <span className="text-gray-400">Drop {idx + 1}</span>}
                  {prov.placeholder}
                </div>
              )}
            </Droppable>
          ))}
        </div>
        <Droppable droppableId="rank-pool" direction="horizontal">
          {(prov) => (
            <div ref={prov.innerRef} {...prov.droppableProps} className="flex space-x-2">
              {top5.filter((id) => !order.includes(id)).map((id, idx) => (
                <Draggable key={id} draggableId={id} index={idx}>
                  {(p) => <div ref={p.innerRef} {...p.draggableProps} {...p.dragHandleProps} className="p-2 bg-gray-100 rounded">{id}</div>}
                </Draggable>
              ))}
              {prov.placeholder}
            </div>
          )}
        </Droppable>
      </div>
    </DragDropContext>
  );
}

export default function App() {
  const [step, setStep] = useState(1);
  const [selected, setSelected] = useState([]);
  const [pool, setPool] = useState([]);
  const [finalOrder, setFinalOrder] = useState([]);
  const canvasRef = useRef();

  const toggleSelect = useCallback((id) => {
    setSelected((s) => s.includes(id) ? s.filter((x) => x !== id) : s.length < 15 ? [...s, id] : s);
  }, []);

  const handlePoolComplete = useCallback((ordered) => { setPool(ordered); setStep(3); }, []);
  const handleFinalize = useCallback((order) => {
    setFinalOrder(order);
    const canvas = document.createElement('canvas');
    canvas.width = 600; canvas.height = 400;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.font = '28px Arial'; ctx.fillStyle = '#000'; ctx.fillText('My Top Five Values', 20, 50);
    ctx.font = '20px Arial';
    order.forEach((val, i) => ctx.fillText(`${i+1}. ${val}`, 20, 100 + i*40));
    canvas.toBlob((blob) => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'my_top_five_values.png';
      a.click();
      URL.revokeObjectURL(url);
    });
  }, []);

  return (
    <div className="max-w-3xl mx-auto shadow-lg rounded-lg p-6 bg-white">
      {step === 1 && (
        <StepSelector
          values={VALUES}
          selected={selected}
          toggleSelect={toggleSelect}
          onNext={() => { setPool(selected); setStep(2); }}
        />
      )}
      {step === 2 && <StepPool items={pool} onComplete={handlePoolComplete} />}
      {step === 3 && <StepRank top5={pool.slice(0,5)} onFinalize={handleFinalize} />}
    </div>
  );
}
